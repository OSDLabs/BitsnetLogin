#!/bin/bash


# Load util functions
source ~/.local/lib/bitsnet/util.sh

# Add a configuration file
source ~/.bitsnetrc

# Parse arguments
while getopts "u:p:dhUo" o; do
    case "${o}" in
        u)
            username=${OPTARG}
            ;;
        p)
            password=${OPTARG}
            ;;
        d)
            debug=1
            debug_msg "Going into debug mode"
            ;;
        U)
            update
            ;;
        o)
            logOut
            ;;
        h | * | [?])
            show_help
            ;;
    esac
done


debug_msg "Username: $username"
debug_msg "Password: $password"
debug_msg "LoginURL: $login_url"


# Check if using bitsnet
# This is being implemented by sending a spider request to the local LMS server
debug_msg "Checking if connected to bitsnet"
if ! wget -qT 5 -t 1 --spider --no-check-certificate http://photon.bits-goa.ac.in
then
    send_msg "Not connected to bitsnet"
    exit
else
    debug_msg "Connected to bitsnet"
fi


# Check if already logged in
debug_msg "Checking if already connected"
if wget -qT 5 -t 1 --spider --no-check-certificate https://google.com
then
    send_msg "Already logged into the BITSnet"
    exit
fi


# Check if username or password are empty
debug_msg "Checking if username or password is empty"
if [[ ("$username" == "") || ("$password" == "") ]]; then
    send_msg "Username or password empty"
    debug_msg "Exiting"
    exit
fi
debug_msg "Not empty"


# Check if using wifi or ethernet
devInfo="$(nmcli dev | grep " connected" | cut -d " " -f1)"
debug_msg ""
debug_msg "Checking device info"
debug_msg "devInfo = $devInfo"
if [[ $devInfo == "en"* ]]; then
    # ethernet
    dev=1
elif [[ $devInfo == "wl"* ]]; then
    # wifi
    dev=2
else
    # unknown
    dev=0
fi
debug_msg "dev = $dev"


# Exit if dev = 0
if [[ "$dev" == "0" ]]; then
    debug_msg "Exiting because dev is zero"
    send_msg "Network interface unknown."
    exit
fi


# Select correct login page according to IP
# and load corresponding login_url
debug_msg ""
debug_msg "Selecting login url"
debug_msg "Using url: $login_url"


# Login
debug_msg ""
debug_msg "Logging in"
if [[ "$dev" == "2" ]]; then
    debug_msg "Connected to wifi. Sending request to cisco router form"
    wget --post-data="username=$username&password=$password&loginAccept=1&buttonClicked=4&err_flag=0&info_flag=0&Submit=Submit&err_msg=&info_msg=&redirect_url=" https://20.20.2.11/login.html --no-check-certificate --quiet -O /dev/null
fi
reply=$(wget -qO- --no-check-certificate --post-data="mode=191&username=$username&password=$password" $login_url)

# Extract reply
debug_msg "Extracting reply"
reply=$(extract_msg $reply)


# Display reply or send a notification
debug_msg ""
send_msg "$reply"
debug_msg "Reply sent"


# Exit
debug_msg ""
debug_msg "Exiting"
exit
